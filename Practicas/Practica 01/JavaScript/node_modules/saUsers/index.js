const daoUsers = require('daoUsers');
const dateFormat = require('dateFormat');
const parser = require('parser');

function doLogin(user, pass, pool, callback){
    let daoUser = new daoUsers(pool);
    
    if (parser.parsePass(pass)){
		daoUser.getUser(user.email, pass, function(err, rows){
			if (err) {
				callback(-5, err.message, null);
			} else {			
				if (rows.length == 0){
                    callback(-1, "Usuario no encontrado", null);
				} else if (rows[0].password != pass) {
                    callback(-2, "Contrase√±a incorrecta", null);
				} else {
					callback(0, "Login correcto", {
						email: rows[0].email,
						name: rows[0].name,
						gender: rows[0].gender,
						years: dateFormat.calculateAge(rows[0].birthdate),
						image: rows[0].image,
						points: 0
					})
				}
			}
		})
	} else {
		callback(-3, "Error al parsear", null);
	}
}

module.exports = {
    doLogin: doLogin
}